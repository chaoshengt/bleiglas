---
output: github_document
editor_options: 
  chunk_output_type: console
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup}
library(magrittr)
library(knitr)
library(rgl)
knit_hooks$set(webgl = hook_rgl)
```

# bleiglas

bleiglas is an R package that provides some helper functions for 3D tessellation and subsequent cutting of the resulting polygons along one dimension for plotting.

## 3D tessellation

Let's get some data in three dimension with an arbitrary sample variable. I decided to use @dirkseidenstickers *Archives des datations radiocarbone d'Afrique centrale* dataset for this purpose. It includes radiocarbon datings 

<details><summary>Click here for details of data preparation</summary>
<p>
```{r, message=FALSE}
c14_cmr <- c14bazAAR::get_c14data("adrac") %>% 
  dplyr::filter(!is.na(lat) & !is.na(lon), c14age > 1000, c14age < 3000, country == "CMR")

coords <- data.frame(c14_cmr$lat, c14_cmr$lon) %>% 
  sf::st_as_sf(coords = c(1, 2), crs = 4326) %>% 
  sf::st_transform(crs = 4088) %>% 
  sf::st_coordinates()

c14 <- c14_cmr %>% 
  dplyr::transmute(
    id = 1:nrow(.),
    x = coords[,1], 
    y = coords[,2], 
    z = c14age * 1000 # necessary rescaling of temporal data
)
```
</p>
</details>

```{r}
c14 
```

Run tessellation 

```{r}
raw_voro_output <- bleiglas::tessellate(c14[, c("id", "x", "y", "z")])
```

Read voro++ output

```{r}
polygon_edges <- bleiglas::read_polygon_edges(raw_voro_output)
```

plot edges and data

```{r}
polygon_edges %<>% dplyr::mutate(
  z.a = z.a / 1000,
  z.b = z.b / 1000
)

c14 %<>% dplyr::mutate(
  z = z / 1000
)
```

3d plot with sample points and polygons

```{r, webgl=TRUE}
rgl::axes3d()
rgl::points3d(c14$x, c14$y, c14$z, color = "red")
rgl::aspect3d(1, 1, 1)
rgl::segments3d(
  x = as.vector(t(polygon_edges[,c(1,4)])),
  y = as.vector(t(polygon_edges[,c(2,5)])),
  z = as.vector(t(polygon_edges[,c(3,6)]))
)
```
